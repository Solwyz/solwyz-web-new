name: Deploy solwyz-client

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: frontend-deploy
      cancel-in-progress: true
    env:
      SHA: ${{ github.sha }}
      TAR: solwyz-client_${{ github.sha }}.tar

    steps:
    - uses: actions/checkout@v4

    - name: Build frontend image
      run: docker build -t solwyz-client:${{ env.SHA }} .

    - name: Save image to tarball
      run: docker save solwyz-client:${{ env.SHA }} -o ${{ env.TAR }}

    - name: Copy tar to droplet
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DROPLET_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: ${{ env.TAR }}
        target: ~/app/frontend/

    - name: Load + restart solwyz-client
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DROPLET_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ~/app/frontend
          docker load -i ${{ env.TAR }}

          docker stop solwyz-client || true && docker rm solwyz-client || true

          docker run -d \
            --name solwyz-client \
            -p 3000:80 \
            --restart unless-stopped \
            solwyz-client:${{ env.SHA }}

          rm -f ${{ env.TAR }}
          docker image prune -f --filter "dangling=true"
